
@(app: controllers.Application)

@shell(app){
	 <div class="row">
            <div class="col-lg-12">
              <h1 class="page-header">Curation Dashboard</h1>
            </div>
            <!-- /.col-lg-12 -->
          </div>
          <!-- /.row -->
          <div class="row">
            <div class="col-lg-3 col-md-6">
              <div class="panel panel-primary">
                <div class="panel-heading">
                  <div class="row">
                    <div class="col-xs-6">
                      <h1>Entities</h1>
                    </div>
                    <div class="col-xs-6 text-right">
                      <h1 id="entity-count"></h1>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-lg-3 col-md-6">
              <div class="panel panel-green">
                <div class="panel-heading">
                  <div class="row">
                    <div class="col-xs-6">
		      <h1>Singletons</h1>
                    </div>
                    <div class="col-xs-6 text-right">
                      <h1 id="singleton-count"></h1>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
	  <!-- /.row -->
          <div class="row">
            <div class="col-lg-3 col-md-6">
              <div class="panel panel-info">
                <div class="panel-heading">
                  <div class="row">
                    <div class="col-xs-6">
                      <h1>Components</h1>
                    </div>
                    <div class="col-xs-6 text-right">
                      <h1 id="component-count"></h1>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-lg-3 col-md-6">
              <div class="panel panel-warning">
                <div class="panel-heading">
                  <div class="row">
                    <div class="col-xs-6">
		      <h1>Stitches</h1>
                    </div>
                    <div class="col-xs-6 text-right">
                      <h1 id="stitch-count"></h1>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <!-- /.row -->

	  <div class="row">
            <div class="col-lg-8">
              <div class="panel panel-default">
                <div class="panel-heading">
                  <i class="fa fa-bar-chart-o fa-fw"></i> Entity Degree Distribution
                </div> <!-- /.panel-heading -->
                <div class="panel-body">
		  <div id="entity-dist-plot"></div>
                </div>  <!-- /.panel-body -->
              </div> <!-- panel -->
	    </div> <!-- col -->
	  </div> <!-- row -->

	  <div class="row">
            <div class="col-lg-8">
              <div class="panel panel-default">
                <div class="panel-heading">
                  <i class="fa fa-bar-chart-o fa-fw"></i> Stitch Distribution
                </div> <!-- /.panel-heading -->
                <div class="panel-body">
		  <div id="stitch-dist-plot"></div>
                </div>  <!-- /.panel-body -->
              </div> <!-- panel -->
	    </div> <!-- col -->
	  </div> <!-- row -->

	  <div class="row">
            <div class="col-lg-8">
              <div class="panel panel-default">
                <div class="panel-heading">
                  <i class="fa fa-bar-chart-o fa-fw"></i> Component Size Distribution
                </div> <!-- /.panel-heading -->
                <div class="panel-body">
		  <div id="component-dist-plot"></div>
                </div>  <!-- /.panel-body -->
              </div> <!-- panel -->
	    </div> <!-- col -->
	  </div> <!-- row -->

	  <div class="row">
            <div class="col-lg-8">
              <div class="panel panel-default">
                <div class="panel-heading">
                  <i class="fa fa-archive fa-fw"></i> Payload (@app.service.getPayloads.size)
                  <a href='@routes.Application.upload' role="button"
	      	     class="btn btn-primary btn-xs pull-right">Add</a>
                </div> <!-- /.panel-heading -->
                <div class="panel-body">
		      @defining(app.service.getPayloads) { payload =>
		      <table class="table table-striped">
		        <thead>
		          <tr>
		            <th></th>
		            <th>Name</th>
		            <th>File <i class="fa fa-download"></i></th>
			    <th>Date</th>
		       	  </tr>
		        </thead>
		        <tbody>
                     	@for(p <- payload.subList(0,Math.min(5,payload.size))) {
 		           <tr>
			     <td><i class="fa fa-@if(p.shared){unlock}else{lock}"></i></td>
			     <td><a href='@{routes.Application.getPayload(p.sha1())}' title='View payload details'>@p.title</td>
			     <td><a href='@{routes.Api.download(p.sha1())}' title='Download payload'>@p.filename</a></td>
			     <td>@{new java.util.Date(p.timestamp)}</td>
			   </tr>
			}
		        </tbody>
	              </table>
		      @if(payload.size > 5) {
		         <a href='@routes.Application.payload'>See all...</a>
		      }
		      }
                </div>  <!-- /.panel-body -->
              </div> <!-- panel -->
	    </div> <!-- col -->
	  </div> <!-- row -->
}

<script>

function toArray(x, y, obj) {
   var data = [];
   for (var f in obj) {
      data.push({x: f, y: obj[f]});
   }
   console.log(data);
   return data;
}

$(document).ready(function () {
   $.ajax({
      url: '@routes.Api.getMetrics(null)',
      retryLimit: 5,
      tries: 0,
      success: function(d) {
         console.log('metrics: count='+d.entityCount+' singletons='+d.singletonCount);
	 $('#entity-count').append(''+d.entityCount);
	 $('#singleton-count').append(''+d.singletonCount);
	 $('#component-count').append(''+d.connectedComponentCount);
	 $('#stitch-count').append(''+d.stitchCount);

	 Morris.Bar({
	   element: 'entity-dist-plot',
	   data: toArray('x', 'y', d.entitySizeDistribution),
	   xkey: 'x',
	   ykeys: ['y'],
	   labels: ['Count']
	 });

	 Morris.Bar({
	   element: 'stitch-dist-plot',
	   data: toArray('x', 'y', d.stitchHistogram),
	   xkey: 'x',
	   ykeys: ['y'],
	   axes: true,
	   hideHover: 'auto',
	   pointSize: 2,
	   barRatio: 0.4,
	   xLabelAngle: 35,
	   labels: ['Count']
	 });

	 Morris.Bar({
	   element: 'component-dist-plot',
	   data: toArray('x', 'y', d.connectedComponentHistogram),
	   xkey: 'x',
	   ykeys: ['y'],
	   axes: true,
	   hideHover: 'auto',
	   pointSize: 2,
	   labels: ['Count']
	 });

      },
      error: function(xhr, status, err) {
         console.log('error: '+err);
         if (xhr.status == 404) { // not ready
	    this.tries++;
	    if (this.tries <= this.retryLimit) {
	       var x = this;
	       setTimeout(function() {
                  console.log('retry..'+x.tries);
	          $.ajax(x);
	       }, 2000);
	    }
	 }
      }
   }).done(function(d) {
   });
});
</script>